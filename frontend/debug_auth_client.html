<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioBook Organizer - Auth Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .check {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .pass { border-left-color: #28a745; background: #d4edda; }
        .fail { border-left-color: #dc3545; background: #f8d7da; }
        .warn { border-left-color: #ffc107; background: #fff3cd; }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .button:hover { background: #0056b3; }
        .code {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .result { margin-top: 2rem; }
    </style>
</head>
<body>
    <h1>üîç AudioBook Organizer - Client Auth Diagnostics</h1>
    
    <div class="check">
        <h3>System Information</h3>
        <div id="systemInfo">Checking...</div>
    </div>
    
    <div class="check">
        <h3>Browser Storage</h3>
        <div id="storageInfo">Checking...</div>
        <button class="button" onclick="clearAllStorage()">Clear All Storage</button>
    </div>
    
    <div class="check">
        <h3>Network Connectivity</h3>
        <div id="networkInfo">Checking...</div>
        <button class="button" onclick="testNetworkConnectivity()">Test Network</button>
    </div>
    
    <div class="check">
        <h3>API Endpoints</h3>
        <div id="apiInfo">Checking...</div>
        <button class="button" onclick="testAPIEndpoints()">Test APIs</button>
    </div>
    
    <div class="check">
        <h3>Authentication State</h3>
        <div id="authInfo">Checking...</div>
        <button class="button" onclick="checkAuthState()">Check Auth</button>
    </div>
    
    <div class="result">
        <h3>Manual Fix Commands</h3>
        <div class="code" id="fixCommands">
// Run these commands in browser console to fix common issues:

// 1. Clear all storage
localStorage.clear();
sessionStorage.clear();
document.cookie.split(";").forEach(function(c) { 
    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
});

// 2. Clear Supabase specific storage
Object.keys(localStorage).forEach(key => {
    if (key.startsWith('sb-') || key.includes('supabase') || key.includes('auth')) {
        localStorage.removeItem(key);
    }
});

// 3. Reload page
window.location.reload();

// 4. Check if incognito mode helps
console.log('Try opening in incognito/private browsing mode');
        </div>
    </div>

    <script>
        // System Information Check
        function checkSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                localTime: new Date().toString(),
                utcTime: new Date().toUTCString(),
                timestamp: Date.now(),
                cookiesEnabled: navigator.cookieEnabled,
                localStorage: typeof(Storage) !== "undefined",
                sessionStorage: typeof(Storage) !== "undefined",
                indexedDB: typeof(indexedDB) !== "undefined"
            };
            
            let html = '<ul>';
            for (const [key, value] of Object.entries(info)) {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            html += '</ul>';
            
            document.getElementById('systemInfo').innerHTML = html;
        }

        // Storage Information Check
        function checkStorageInfo() {
            const storageKeys = {
                localStorage: Object.keys(localStorage),
                sessionStorage: Object.keys(sessionStorage)
            };
            
            let html = '<h4>Local Storage Keys:</h4><ul>';
            storageKeys.localStorage.forEach(key => {
                const isAuth = key.includes('auth') || key.includes('supabase') || key.startsWith('sb-');
                const className = isAuth ? 'style="color: red; font-weight: bold;"' : '';
                html += `<li ${className}>${key}</li>`;
            });
            html += '</ul>';
            
            html += '<h4>Session Storage Keys:</h4><ul>';
            storageKeys.sessionStorage.forEach(key => {
                const isAuth = key.includes('auth') || key.includes('supabase') || key.startsWith('sb-');
                const className = isAuth ? 'style="color: red; font-weight: bold;"' : '';
                html += `<li ${className}>${key}</li>`;
            });
            html += '</ul>';
            
            document.getElementById('storageInfo').innerHTML = html;
        }

        // Clear All Storage
        function clearAllStorage() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                document.getElementById('storageInfo').innerHTML = '<span style="color: green;">‚úÖ All storage cleared successfully!</span>';
                
                setTimeout(() => {
                    if (confirm('Storage cleared. Reload page now?')) {
                        window.location.reload();
                    }
                }, 1000);
                
            } catch (error) {
                document.getElementById('storageInfo').innerHTML = `<span style="color: red;">‚ùå Error clearing storage: ${error.message}</span>`;
            }
        }

        // Network Connectivity Test
        async function testNetworkConnectivity() {
            const tests = [
                { name: 'Local Server', url: '/api/test' },
                { name: 'Supabase (via local)', url: '/api/auth/config' },
                { name: 'External connectivity', url: 'https://httpbin.org/get' }
            ];
            
            let html = '<h4>Network Tests:</h4><ul>';
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, { method: 'GET' });
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    html += `<li>${status} ${test.name}: ${response.status} ${response.statusText}</li>`;
                } catch (error) {
                    html += `<li>‚ùå ${test.name}: ${error.message}</li>`;
                }
            }
            
            html += '</ul>';
            document.getElementById('networkInfo').innerHTML = html;
        }

        // API Endpoints Test
        async function testAPIEndpoints() {
            const endpoints = [
                '/api/auth/config',
                '/api/auth/status',
                '/debug/config',
                '/api/stripe/config'
            ];
            
            let html = '<h4>API Endpoint Tests:</h4><ul>';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    const data = await response.text();
                    html += `<li>${status} ${endpoint}: ${response.status} (${data.length} bytes)</li>`;
                } catch (error) {
                    html += `<li>‚ùå ${endpoint}: ${error.message}</li>`;
                }
            }
            
            html += '</ul>';
            document.getElementById('apiInfo').innerHTML = html;
        }

        // Check Authentication State
        async function checkAuthState() {
            let html = '<h4>Authentication State:</h4><ul>';
            
            // Check for auth-related objects in global scope
            const authObjects = [
                'window.authModule',
                'window.sessionManager',
                'window.tempAuthManager',
                'window.router'
            ];
            
            authObjects.forEach(obj => {
                const exists = eval(`typeof ${obj} !== 'undefined'`);
                const status = exists ? '‚úÖ' : '‚ùå';
                html += `<li>${status} ${obj}: ${exists ? 'Available' : 'Not found'}</li>`;
            });
            
            // Check Supabase in localStorage
            const supabaseKeys = Object.keys(localStorage).filter(key => 
                key.startsWith('sb-') || key.includes('supabase')
            );
            
            html += `<li>üîë Supabase storage keys: ${supabaseKeys.length}</li>`;
            supabaseKeys.forEach(key => {
                html += `<li style="margin-left: 20px;">- ${key}</li>`;
            });
            
            html += '</ul>';
            
            // Try to call auth status API
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                html += `<h4>Auth Status API Response:</h4><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                html += `<h4>Auth Status API Error:</h4><p style="color: red;">${error.message}</p>`;
            }
            
            document.getElementById('authInfo').innerHTML = html;
        }

        // Auto-run initial checks
        window.addEventListener('load', () => {
            checkSystemInfo();
            checkStorageInfo();
            testNetworkConnectivity();
        });
    </script>
</body>
</html> 